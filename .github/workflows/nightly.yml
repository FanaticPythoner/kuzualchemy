name: Nightly (rolling main pre-release)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: nightly-main
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONNOUSERSITE: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_INPUT: "1"

jobs:
  build-and-update:
    name: Build universal wheel + sdist; update 'nightly' pre-release
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: (act-only) sanitize toolcache leftovers
        if: ${{ env.ACT == 'true' }}
        run: |
          set -euxo pipefail
          find /opt/hostedtoolcache -type d -path "*/site-packages/~*" -maxdepth 1 -print -exec rm -rf {} + || true

      - name: Build sdist + universal wheel
        run: |
          set -euxo pipefail
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip build twine
          python -m build --sdist --wheel
          python -m twine check dist/*
          ls -lh dist

      - name: Generate SHA256SUMS.txt
        run: |
          set -euxo pipefail
          cd dist
          (for f in *; do sha256sum "$f"; done) > SHA256SUMS.txt
          ls -l

      # Move the 'nightly' tag only on GitHub-hosted runners (not under act).
      - name: Move 'nightly' tag to this commit (force)
        if: ${{ env.ACT != 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euxo pipefail
          git tag -fa nightly $GITHUB_SHA
          git push -f origin nightly

      - name: Create/Update Nightly pre-release (replace assets)
        if: ${{ env.ACT != 'true' }}
        uses: ncipollo/release-action@v1
        with:
          tag: nightly
          name: Nightly (main)
          allowUpdates: true
          replacesArtifacts: true
          artifactErrorsFailBuild: true
          generateReleaseNotes: false
          draft: false
          prerelease: true
          artifacts: "dist/*"

      # Under act, just prove the build completed and would have uploaded.
      - name: Nightly summary (act)
        if: ${{ env.ACT == 'true' }}
        run: |
          set -euxo pipefail
          echo "## Nightly build completed (act local run)" >> $GITHUB_STEP_SUMMARY
          ls -lh dist >> $GITHUB_STEP_SUMMARY
